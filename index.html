<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>GEMAI Chat</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <span>â˜° GEMAI chat</span>
            <div class="new-chat-btn" id="new-chat-btn">+</div>
        </div>
        <div class="chat-list" id="chat-list"></div>
    </aside>

    <main class="main-content">
        <h1 class="main-title">GEMAI</h1>
        <div class="split-view">
            <div class="panel chat-display" id="chat-display"></div>
            <div class="panel face-panel">
                <div class="orb" id="orb"><span class="face-emoji" id="face-emoji">ğŸ˜´</span></div>
                <div id="status-text" style="margin-top:20px; font-size:12px; color:#999;">Sleeping...</div>
            </div>
        </div>
        <div class="input-wrapper">
            <div class="input-container">
                <textarea id="user-input" class="input-field" rows="1" placeholder="What would you like to know?"></textarea>
                <div class="input-actions">
                    <div class="tools">ğŸ–¼ï¸ ğŸ”— ğŸ¤</div>
                    <button id="send-btn" class="send-btn">â†‘</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const chatDisplay = document.getElementById('chat-display');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const chatList = document.getElementById('chat-list');
        const orb = document.getElementById('orb');
        const faceEmoji = document.getElementById('face-emoji');
        const statusText = document.getElementById('status-text');

        // marked ì„¤ì •: í•˜ì´ë¼ì´íŠ¸ ì ìš©
        marked.setOptions({
            highlight: function(code, lang) {
                return hljs.highlightAuto(code).value;
            },
            breaks: true
        });

        let chats = JSON.parse(localStorage.getItem('gemai_storage')) || [];
        let currentChatId = null;

        function setAIState(state) {
            orb.className = 'orb';
            if(state === 'sleeping') { faceEmoji.textContent='ğŸ˜´'; statusText.textContent='Sleeping...'; }
            else if(state === 'thinking') { orb.classList.add('thinking'); faceEmoji.textContent='ğŸ¤”'; statusText.textContent='Thinking...'; }
            else if(state === 'speaking') { orb.classList.add('speaking'); faceEmoji.textContent=['ğŸ—£ï¸','ğŸ’¬'][Math.floor(Math.random()*2)]; statusText.textContent='Speaking...'; }
        }

        function renderList() {
            chatList.innerHTML = '';
            chats.forEach(c => {
                const div = document.createElement('div');
                div.className = `chat-item ${c.id === currentChatId ? 'active' : ''}`;
                div.innerHTML = `
                    <span class="chat-title-text" onclick="loadChat('${c.id}')">${c.title}</span>
                    <div class="chat-actions">
                        <button onclick="renameChat('${c.id}')">âœï¸</button>
                        <button onclick="deleteChat('${c.id}')">ğŸ—‘ï¸</button>
                    </div>`;
                chatList.appendChild(div);
            });
        }

        function loadChat(id) {
            currentChatId = id;
            const chat = chats.find(c => c.id === id);
            chatDisplay.innerHTML = '';
            if (chat) {
                chat.history.forEach(m => appendUI(m.role, m.content));
            }
            renderList();
            save();
        }

        document.getElementById('new-chat-btn').onclick = () => {
            currentChatId = Date.now().toString();
            chats.unshift({id: currentChatId, title: 'New Chat', history: []});
            save();
            loadChat(currentChatId);
        };

        window.deleteChat = (id) => {
            if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
            chats = chats.filter(c => c.id !== id);
            if(currentChatId === id) {
                currentChatId = chats.length > 0 ? chats[0].id : null;
            }
            save();
            if(currentChatId) loadChat(currentChatId); else location.reload();
        };

        window.renameChat = (id) => {
            const n = prompt("ìƒˆ ëŒ€í™” ì´ë¦„:");
            if(n) { chats.find(c=>c.id===id).title = n; save(); renderList(); }
        };

        function save() { localStorage.setItem('gemai_storage', JSON.stringify(chats)); }

        function appendUI(role, text) {
            const group = document.createElement('div');
            group.className = 'message-group';
            // ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ì ìš© (ì½”ë“œ ë¸”ë¡ í¬í•¨)
            const contentHTML = role === 'user' ? text : marked.parse(text);
            
            group.innerHTML = role === 'user' 
                ? `<div class="message-box user-msg">${contentHTML}</div>`
                : `<div class="ai-msg"><span class="ai-icon">âŸ¡</span><div class="ai-text">${contentHTML}</div></div>`;
            
            chatDisplay.appendChild(group);
            // ìƒˆë¡œ ìƒì„±ëœ ì½”ë“œ ë¸”ë¡ì— í•˜ì´ë¼ì´íŒ… ê°•ì œ ì ìš©
            group.querySelectorAll('pre code').forEach((block) => { hljs.highlightElement(block); });
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        async function handleSend() {
            const text = userInput.value.trim();
            if(!text) return;
            if(!currentChatId) document.getElementById('new-chat-btn').onclick();

            appendUI('user', text);
            const chat = chats.find(c => c.id === currentChatId);
            if(chat.title === 'New Chat') chat.title = text.substring(0, 15);
            chat.history.push({role: 'user', content: text});
            
            userInput.value = '';
            userInput.style.height = 'auto';
            setAIState('thinking');

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ messages: chat.history })
                });
                const data = await res.json();
                
                setAIState('speaking');
                const aiResponse = data.content || "ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                appendUI('assistant', aiResponse);
                chat.history.push({role: 'assistant', content: aiResponse});
                save();
                renderList();
                setTimeout(() => setAIState('sleeping'), 4000);
            } catch (e) {
                appendUI('assistant', "âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
                setAIState('sleeping');
            }
        }

        sendBtn.onclick = handleSend;
        userInput.onkeydown = (e) => { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }};
        
        // ì…ë ¥ì°½ ìë™ ë†’ì´ ì¡°ì ˆ
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // ì´ˆê¸° ë¡œë“œ: ì´ì „ ì±— ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ ìˆ˜ì •
        if(chats.length > 0) {
            loadChat(chats[0].id);
        } else {
            setAIState('sleeping');
        }
    </script>
</body>
</html>