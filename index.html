<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>GEMAI</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header"><span>â˜° GEMAI chat</span><div class="new-chat-btn" id="new-chat-btn">+</div></div>
        <div class="chat-list" id="chat-list"></div>
    </aside>

    <main class="main-content">
        <h1 class="main-title">GEMAI</h1>
        <div class="split-view">
            <div class="panel chat-display" id="chat-display"></div>
            <div class="panel face-panel">
                <div class="orb" id="orb"><span class="face-emoji" id="face-emoji">ğŸ˜´</span></div>
                <div id="status-text" style="margin-top:20px; font-size:12px; color:#999;">Sleeping...</div>
            </div>
        </div>
        <div class="input-wrapper"><div class="input-container">
            <textarea id="user-input" class="input-field" rows="1" placeholder="What would you like to know?"></textarea>
            <div class="input-actions"><div>ğŸ–¼ï¸ ğŸ”— ğŸ¤</div><button id="send-btn" class="send-btn">â†‘</button></div>
        </div></div>
    </main>

    <script>
        const chatDisplay = document.getElementById('chat-display');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const chatList = document.getElementById('chat-list');
        const orb = document.getElementById('orb');
        const faceEmoji = document.getElementById('face-emoji');
        const statusText = document.getElementById('status-text');

        let chats = JSON.parse(localStorage.getItem('gemai_db')) || [];
        let currentChatId = null;

        function setAIState(state) {
            orb.className = 'orb';
            if(state === 'sleeping') { faceEmoji.textContent='ğŸ˜´'; statusText.textContent='Sleeping...'; }
            else if(state === 'thinking') { orb.classList.add('thinking'); faceEmoji.textContent='ğŸ¤”'; statusText.textContent='Thinking...'; }
            else if(state === 'speaking') { orb.classList.add('speaking'); faceEmoji.textContent=['ğŸ—£ï¸','ğŸ’¬'][Math.floor(Math.random()*2)]; statusText.textContent='Speaking...'; }
        }

        function renderList() {
            chatList.innerHTML = '';
            chats.forEach(c => {
                const div = document.createElement('div');
                div.className = `chat-item ${c.id === currentChatId ? 'active' : ''}`;
                div.innerHTML = `<span onclick="loadChat('${c.id}')">${c.title}</span>
                    <div class="chat-actions"><button onclick="renameChat('${c.id}')">âœï¸</button><button onclick="deleteChat('${c.id}')">ğŸ—‘ï¸</button></div>`;
                chatList.appendChild(div);
            });
        }

        function loadChat(id) {
            currentChatId = id;
            const chat = chats.find(c => c.id === id);
            chatDisplay.innerHTML = '';
            chat.history.forEach(m => appendUI(m.role, m.content));
            renderList();
        }

        document.getElementById('new-chat-btn').onclick = () => {
            currentChatId = Date.now().toString();
            chats.unshift({id: currentChatId, title: 'New Chat', history: []});
            save(); loadChat(currentChatId);
        };

        window.deleteChat = (id) => { chats = chats.filter(c => c.id !== id); save(); location.reload(); };
        window.renameChat = (id) => { const n = prompt("Name:"); if(n){ chats.find(c=>c.id===id).title=n; save(); renderList(); }};
        function save() { localStorage.setItem('gemai_db', JSON.stringify(chats)); }

        function appendUI(role, text) {
            const group = document.createElement('div'); group.className = 'message-group';
            group.innerHTML = role === 'user' ? `<div class="message-box user-msg">${text}</div>` : 
                `<div class="ai-msg"><span class="ai-icon">âŸ¡</span><div class="ai-text">${marked.parse(text)}</div></div>`;
            chatDisplay.appendChild(group);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        async function handleSend() {
            const text = userInput.value.trim(); if(!text) return;
            if(!currentChatId) document.getElementById('new-chat-btn').click();
            
            appendUI('user', text);
            const chat = chats.find(c => c.id === currentChatId);
            if(chat.title === 'New Chat') chat.title = text.substring(0,10);
            chat.history.push({role:'user', content:text});
            
            userInput.value = ''; setAIState('thinking');
            try {
                const res = await fetch('/api/chat', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({messages: chat.history})});
                const data = await res.json();
                setAIState('speaking');
                appendUI('assistant', data.content);
                chat.history.push({role:'assistant', content:data.content});
                save(); renderList();
                setTimeout(() => setAIState('sleeping'), 3000);
            } catch { setAIState('sleeping'); }
        }

        sendBtn.onclick = handleSend;
        userInput.onkeydown = (e) => { if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); handleSend(); }};
        if(chats.length > 0) loadChat(chats[0].id); else setAIState('sleeping');
    </script>
</body>
</html>