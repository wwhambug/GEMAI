<script>
    const chatDisplay = document.getElementById('chat-display');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    let chatHistory = [];

    function appendMessage(role, text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = role === 'user' ? 'message-box user-msg' : 'message-box ai-msg';
        
        if (role === 'user') {
            msgDiv.textContent = text;
        } else {
            const parsed = typeof marked !== 'undefined' ? marked.parse(text) : text;
            msgDiv.innerHTML = `<span class="ai-icon">⟡</span><div class="ai-text">${parsed}</div>`;
        }
        chatDisplay.appendChild(msgDiv);
        chatDisplay.scrollTop = chatDisplay.scrollHeight;
    }

    async function handleSend() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage('user', text);
        userInput.value = '';

        const loading = document.createElement('div');
        loading.className = 'message-box ai-msg';
        loading.innerHTML = `<span class="ai-icon">⟡</span><div class="ai-text">Thinking...</div>`;
        chatDisplay.appendChild(loading);

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: [...chatHistory, { role: 'user', content: text }] })
            });

            const data = await response.json();
            chatDisplay.removeChild(loading);

            if (data.content) {
                appendMessage('assistant', data.content);
                chatHistory.push({ role: 'user', content: text });
                chatHistory.push({ role: 'assistant', content: data.content });
            } else {
                appendMessage('assistant', `⚠️ 에러: ${data.error || '알 수 없는 오류'}`);
            }
        } catch (err) {
            if (chatDisplay.contains(loading)) chatDisplay.removeChild(loading);
            appendMessage('assistant', '❌ 시스템 오류가 발생했습니다.');
        }
    }

    sendBtn.addEventListener('click', handleSend);
    userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } });
</script>